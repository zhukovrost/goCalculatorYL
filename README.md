# Распределенный вычислитель арифметических выражений (оркестратор)

Финальное задание курса по GoLang Яндекс Лицея

Этот сервис принимает на вход арифметические выражения и разбивает их на задачи. 
Другой сервис (*агент*) запрашивает у оркестратора эти задачи, считает их, возвращает результат. 
Оркестратор также обрабатывает результаты *агента*.
Также можно отслеживать статус и результат каждого выражения.

![SVG Image](service.svg)

## Данный сервис работает с агентом

Подробнее тут: https://github.com/zhukovrost/agentYL.git

## Установка

1. Клонируйте репозиторий:
    ```sh
    git clone https://github.com/zhukovrost/orchestratorYL.git
    ```

2. Перейдите в директорию проекта:
    ```sh
    cd orchestratorYL
    ```
   
3. **При необходимости** установите окружение (Linux):

   ```sh 
   export PATH=$PATH:/usr/local/go/bin
   ```

4. Установите зависимости:
    ```sh
    go mod tidy
    ```

## Запуск

Для запуска сервера выполните:

```sh
go run cmd/orchestrator/main.go
```

## Настройка (при необходимости)

Вы можете поменять время выполнения арифметических операций.
Для этого можете поменять значения переменных окружения:

- MATH_ADDITION
- MATH_SUBTRACTION
- MATH_MULTIPLICATION
- MATH_DIVISION

Вот пример запуска с определёнными настройками:

```sh
MATH_ADDITION=7000 MATH_SUBTRACTION=200 go run cmd/orchestrator/main.go
```

## Инструкция по использованию

### 1. Регистрация

Для доступа к большинству функций вам потребуется регистрация.
Код ответа будет **200** в случае успешной регистрации. **500** в противном случае.

```sh
 curl http://localhost:8080/api/v1/register \
 --header 'Content-Type: application/json' \
 --data '{
   "login": "student_yandex",
   "password": "password"
 }'
 ```

### 2. Аутентификация

Код ответа будет **200** в случае успешной регистрации. **500** или **404** в противном случае.
В ответе будет JWT токен, который будет работать в течение 15 минут.
```sh
curl http://localhost:8080/api/v1/login \
--header 'Content-Type: application/json' \
--data '{
 "login": "student_yandex",
 "password": "password"
}'
```

Ответ:
```json
{
  "token": "<токен>"
}
```

Для дальнейшего удобства объявим переменную окружения TOKEN:

```sh 
export TOKEN="<токен>"
```

Все последующие endpoint'ы (кроме тех, которые связаны с задачами) требуют наличие точена в хедере:

```
Authorization: Bearer $TOKEN
```

### 3. Добавление арифметического выражения

* Правильное выражение:

   Код ответа будет **201**. Также выражение добавится в очередь и будет иметь статус *pending*. Подобный запрос будет возвращать id выражения.
   ```sh
   curl http://localhost:8080/api/v1/calculate \
   --header "Content-Type: application/json" \
   --header "Authorization: Bearer $TOKEN" \
   --data '{
     "expression": "100 - 5 * (40 - 23) + 3"
   }'
   ```
  Ответ:
  ```json
  {
    "id": 1
  }
  ```

* Выражение с ошибкой (деление на ноль):

  Код ответа будет **422**. Также выражение добавится в очередь и будет иметь статус *invalid*.
  ```sh
  curl http://localhost:8080/api/v1/calculate \
  --header "Content-Type: application/json" \
  --header "Authorization: Bearer $TOKEN" \
  --data '{
   "expression": "4/0 + 1"
  }'
  ```

   Но если добавить выражение, сразу по которому не скажешь, что там есть деление на ноль, то 
код ответа будет **201**. Также выражение добавится в очередь и будет иметь статус *pending*.
В процессе подсчёта выражения будет выявлена ошибка, и статус выражения обновится на *invalid*.
  ```sh
  curl http://localhost:8080/api/v1/calculate \
  --header "Content-Type: application/json" \
  --header "Authorization: Bearer $TOKEN" \
  --data '{
   "expression": "4/(3 - 3) + 90"
  }'
  ```

* Выражение с ошибкой (некорректные входные данные):

   Некоторые выражение могут выдать ошибку **422**. Приведу пример несколько таких:

  * / 5 + 9 -- выражение начинается не с числа. **ВАЖНО!!!** Если вы хотите начать выражение с отрицательного числа, пишите (0 - число)
  * 15 * + 7 -- выражение содержит 2 идущих подряд операнда. **ВАЖНО!!!** Если вы хотите произвести операцию с отрицательным числом, пишите (0 - число)
  * 15 - (123 -- выражение содержит некорректные скобки
  * (11) + 7 -- выражение содержит бесполезные скобки
  * 83 - d + @l -- выражение содержит буквы или другие неиспользуемые символы
  * 6 5 -- выражение содержит пробел между цифрами без арифметического знака
      
* Выражение не содержит выражения:

  Код ответа будет **500**. Также выражение не добавится в очередь.
  ```sh
  curl http://localhost:8080/api/v1/calculate \
  --header "Content-Type: application/json" \
  --header "Authorization: Bearer $TOKEN" \
  --data '{
   "expression": {"notExpression": true}
  }'
  ```

### 4. Получение всех арифметических выражений

```sh 
curl http://localhost:8080/api/v1/expressions \
--header "Authorization: Bearer $TOKEN"
```

Код ответа **200**. Ответом будет:
```json
{
  "expressions": [
    {
      "id": 1,
      "expression": "100 - 5 * (40 - 23) + 3",
      "result": 0,
      "status": "pending"
    }
  ]
}
```

### 5. Получение арифметических выражений по ID

Дан пример получения выражения по ID. Код ответа будет **200**:
```sh
curl http://localhost:8080/api/v1/expressions/1 \
--header "Authorization: Bearer $TOKEN"
```
И ответ:
```json
{
  "expression": {
    "id": 1,
    "expression": "100 - 5 * (40 - 23) + 3",
    "result": 0,
    "status": "pending"
  }
}
```

Если запросить несуществующее выражение код ответа будет **404**. 

### 6. Получение задачи

С данной функцией работает **агент**. Он постоянно запрашивает задачу. Если их нет, то получает код **404**. 
Если есть, то код **200** и ответ.

Вот пример:

```sh
curl http://localhost:8080/internal/task
```

Ответ:

```json
{
   "task": {
      "id":0,
      "arg1":2,
      "arg2":2,
      "operation":"*",
      "operation_time":5000
   }
}
```

### 7. Установить результат задачи

С данной функцией работает **агент**. Он постоянно решает задачу и отправляет результат обратно. 
Если нет задачи с данным id, то получает код **404**. Если есть, то код **200** и ответ, при условии, что данные result валидны, иначе **422**.

```sh
curl http://localhost:8080/internal/task \
--header "Content-Type: application/json" \
--data '{
  "id": 0,
  "result": 4
}'
```
